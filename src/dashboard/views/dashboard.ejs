<!DOCTYPE html>
<html lang="he" dir="rtl">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>נוגה - לוח בקרה</title>
    <link rel="stylesheet" href="/public/css/style.css">
</head>

<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="logo">
                <h1>🏠 נוגה</h1>
                <span class="status-badge" id="status-badge">מתחבר...</span>
            </div>
            <nav>
                <button id="btn-restart" class="btn btn-danger-small" style="margin-left: 8px;">🔄 הפעל מחדש</button>
                <a href="/logout" class="btn btn-secondary">התנתק</a>
            </nav>
        </header>

        <!-- Tab Navigation -->
        <div class="tab-nav">
            <button class="tab-btn active" data-tab="tab-status">📊 סטטוס</button>
            <button class="tab-btn" data-tab="tab-prompt">🧠 הוראות מערכת</button>
            <button class="tab-btn" data-tab="tab-keywords">🔑 מילות מפתח</button>
            <button class="tab-btn" data-tab="tab-scheduled-prompts">⏱️ תזמונים</button>
            <button class="tab-btn" data-tab="tab-console">🖥️ לוג</button>
        </div>

        <!-- Tab Content -->
        <main class="tab-content">

            <!-- ==================== Status Tab ==================== -->
            <div class="tab-pane active" id="tab-status">
                <!-- QR Code Panel (hidden when connected) -->
                <section class="panel qr-panel" id="qr-section">
                    <h2>📱 חיבור WhatsApp</h2>
                    <div class="qr-container">
                        <div id="qr-placeholder" class="qr-placeholder">
                            <% if (qrCode) { %>
                                <img src="<%= qrCode %>" alt="QR Code" class="qr-image">
                                <% } else { %>
                                    <div class="connected-message">
                                        <span class="checkmark">✓</span>
                                        <p>WhatsApp מחובר!</p>
                                    </div>
                                    <% } %>
                        </div>
                        <p class="qr-hint">סרקו את הקוד באפליקציית WhatsApp</p>
                    </div>
                </section>

                <!-- Status Panel -->
                <section class="panel status-panel">
                    <h2>📊 סטטוס מערכת</h2>
                    <div class="status-grid">
                        <div class="status-item" id="status-whatsapp">
                            <span class="status-icon">💬</span>
                            <span class="status-label">WhatsApp</span>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <span class="status-value loading">בודק...</span>
                                <button id="btn-disconnect-wa" class="btn btn-secondary btn-small"
                                    style="display: none; padding: 2px 8px; font-size: 12px; height: auto;">התנתק</button>
                                <button id="btn-reconnect-wa" class="btn btn-primary btn-small"
                                    style="display: none; padding: 2px 8px; font-size: 12px; height: auto;">🔄 התחבר
                                    מחדש</button>
                            </div>
                        </div>
                        <div class="status-item" id="status-gemini">
                            <span class="status-icon">🤖</span>
                            <span class="status-label">Gemini AI</span>
                            <span class="status-value loading">בודק...</span>
                        </div>
                        <div class="status-item" id="status-calendar">
                            <span class="status-icon">📅</span>
                            <span class="status-label">יומן</span>
                            <span class="status-value loading">בודק...</span>
                        </div>
                        <div class="status-item" id="status-tasks">
                            <span class="status-icon">🛒</span>
                            <span class="status-label">קניות</span>
                            <span class="status-value loading">בודק...</span>
                        </div>
                        <div class="status-item" id="status-homeassistant">
                            <span class="status-icon">🏠</span>
                            <span class="status-label">Home Assistant</span>
                            <span class="status-value loading">בודק...</span>
                        </div>
                    </div>
                </section>

                <!-- Usage Stats Panel -->
                <section class="panel usage-panel">
                    <h2>📉 שימוש ועלויות</h2>
                    <div class="usage-grid">
                        <div class="usage-card">
                            <h3>היום</h3>
                            <div class="usage-row">
                                <span>Input Tokens:</span>
                                <span id="usage-today-input">0</span>
                            </div>
                            <div class="usage-row">
                                <span>Output Tokens:</span>
                                <span id="usage-today-output">0</span>
                            </div>
                            <div class="usage-row cost-row">
                                <span>עלות משוערת:</span>
                                <span id="usage-today-cost">$0.0000</span>
                            </div>
                        </div>
                        <div class="usage-card">
                            <h3>החודש</h3>
                            <div class="usage-row">
                                <span>Input Tokens:</span>
                                <span id="usage-month-input">0</span>
                            </div>
                            <div class="usage-row">
                                <span>Output Tokens:</span>
                                <span id="usage-month-output">0</span>
                            </div>
                            <div class="usage-row cost-row">
                                <span>עלות משוערת:</span>
                                <span id="usage-month-cost">$0.0000</span>
                            </div>
                        </div>
                    </div>
                </section>
            </div>

            <!-- ==================== System Prompt Tab ==================== -->
            <div class="tab-pane" id="tab-prompt">
                <section class="panel prompt-panel">
                    <h2>
                        🧠 הוראות מערכת
                        <div class="prompt-actions">
                            <span id="prompt-status" class="save-status"></span>
                            <button id="save-prompt" class="btn btn-primary btn-small">שמור</button>
                        </div>
                    </h2>
                    <p class="panel-hint">הוראות אלו נשלחות ל-Gemini כהקשר מערכת. שינויים נכנסים לתוקף מיידית.</p>
                    <div class="prompt-container">
                        <textarea id="system-prompt" class="prompt-textarea" placeholder="טוען..." dir="ltr"></textarea>
                    </div>
                </section>
            </div>

            <!-- ==================== Keywords Tab ==================== -->
            <div class="tab-pane" id="tab-keywords">
                <section class="panel keywords-panel">
                    <h2>
                        🔑 מילות מפתח
                        <button id="add-keyword-btn" class="btn btn-primary btn-small">+ הוסף</button>
                    </h2>
                    <p class="panel-hint">הגדר מילות מפתח: <strong>סטטי</strong> = תגובה קבועה מיידית,
                        <strong>AI</strong> = הוראות מותאמות ל-Gemini
                    </p>

                    <!-- Add/Edit Form -->
                    <div id="keyword-form" class="keyword-form" style="display: none;">
                        <input type="hidden" id="keyword-edit-id" value="">
                        <div class="form-row">
                            <div class="form-group form-group-grow">
                                <label for="keyword-input">מילת מפתח</label>
                                <input type="text" id="keyword-input" class="form-input"
                                    placeholder='למשל: עזרה,היי,שלום (מופרד בפסיקים)' dir="rtl">
                                <small style="color: var(--gray); font-size: 11px;">ניתן להגדיר מספר מילות מפתח מופרדות
                                    בפסיקים</small>
                            </div>
                            <div class="form-group">
                                <label for="keyword-type">סוג</label>
                                <select id="keyword-type" class="form-input">
                                    <option value="static">⚡ סטטי</option>
                                    <option value="ai">🤖 AI</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="keyword-response" id="keyword-response-label">תגובה</label>
                            <textarea id="keyword-response" class="form-textarea"
                                placeholder="התגובה שתישלח כשהמילה תתקבל" dir="rtl"></textarea>
                        </div>
                        <div class="form-actions">
                            <button id="keyword-save" class="btn btn-primary btn-small">שמור</button>
                            <button id="keyword-cancel" class="btn btn-secondary btn-small">ביטול</button>
                        </div>
                    </div>

                    <!-- Keywords Table -->
                    <div class="keywords-table-container">
                        <table class="keywords-table" id="keywords-table">
                            <thead>
                                <tr>
                                    <th>מילת מפתח</th>
                                    <th>סוג</th>
                                    <th>תגובה / הוראות</th>
                                    <th>פעיל</th>
                                    <th>פעולות</th>
                                </tr>
                            </thead>
                            <tbody id="keywords-tbody">
                                <tr class="empty-row">
                                    <td colspan="5">טוען...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>

            <!-- ==================== Scheduled Prompts Tab ==================== -->
            <div class="tab-pane" id="tab-scheduled-prompts">
                <section class="panel scheduled-prompts-panel">
                    <h2>
                        ⏱️ תזמונים
                        <button id="add-schedule-btn" class="btn btn-primary btn-small">+ הוסף</button>
                    </h2>
                    <p class="panel-hint">הגדר הוראות לביצוע מתוזמן (באמצעות קרון). הפקודות יבוצעו אוטומטית והתוצאה
                        תישלח לקבוצת הוואטסאפ.</p>

                    <!-- Add/Edit Form -->
                    <div id="schedule-form" class="keyword-form" style="display: none;">
                        <input type="hidden" id="schedule-edit-id" value="">
                        <div class="form-row">
                            <div class="form-group form-group-grow">
                                <label for="schedule-name">שם התזמון</label>
                                <input type="text" id="schedule-name" class="form-input" placeholder="למשל: סיכום בוקר"
                                    dir="rtl">
                            </div>
                            <div class="form-group">
                                <label for="schedule-cron">תזמון (Cron)</label>
                                <input type="text" id="schedule-cron" class="form-input" placeholder="למשל: 0 7 * * *"
                                    dir="ltr">
                                <small style="color: var(--gray); font-size: 11px;">
                                    <a href="https://crontab.guru/" target="_blank" style="color: var(--primary);">עזרה
                                        בבניית Cron</a>
                                </small>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="schedule-prompt">הוראה ל-AI</label>
                            <textarea id="schedule-prompt" class="form-textarea"
                                placeholder="למשל: סכם לי את אירועי היום מהיומן" dir="rtl"></textarea>
                        </div>
                        <div class="form-actions">
                            <button id="schedule-save" class="btn btn-primary btn-small">שמור</button>
                            <button id="schedule-cancel" class="btn btn-secondary btn-small">ביטול</button>
                        </div>
                    </div>

                    <!-- Scheduled Prompts Table -->
                    <div class="keywords-table-container">
                        <table class="keywords-table" id="schedules-table">
                            <thead>
                                <tr>
                                    <th>שם</th>
                                    <th>תזמון (Cron)</th>
                                    <th>הוראה</th>
                                    <th>פעיל</th>
                                    <th>פעולות</th>
                                </tr>
                            </thead>
                            <tbody id="schedules-tbody">
                                <tr class="empty-row">
                                    <td colspan="5">טוען...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </section>
            </div>

            <!-- ==================== Console Tab ==================== -->
            <div class="tab-pane" id="tab-console">
                <section class="panel console-panel">
                    <h2>
                        🖥️ לוג מערכת
                    </h2>
                    <!-- Sub-tab navigation -->
                    <div class="log-sub-tabs">
                        <button class="log-sub-tab active" data-log-tab="live-log">📡 לוג חי</button>
                        <button class="log-sub-tab" data-log-tab="server-log">📄 לוג שרת</button>
                    </div>

                    <!-- Live Log Pane -->
                    <div class="log-pane active" id="live-log">
                        <div style="display: flex; justify-content: flex-end; margin-bottom: 8px;">
                            <button id="clear-logs" class="btn btn-small">נקה</button>
                        </div>
                        <div class="console" id="console">
                            <% recentLogs.forEach(log=> { %>
                                <div class="log-entry log-<%= log.level %>">
                                    <span class="log-time">
                                        <%= new Date(log.timestamp).toLocaleTimeString('he-IL') %>
                                    </span>
                                    <span class="log-level">
                                        <%= log.level.toUpperCase() %>
                                    </span>
                                    <span class="log-message">
                                        <%= log.message %>
                                    </span>
                                </div>
                                <% }) %>
                        </div>
                    </div>

                    <!-- Server Log Pane -->
                    <div class="log-pane" id="server-log">
                        <div
                            style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <span id="server-log-info" style="font-size: 12px; color: var(--gray);"></span>
                            <div style="display: flex; gap: 8px; align-items: center;">
                                <select id="server-log-lines" class="form-input"
                                    style="width: auto; padding: 4px 8px; font-size: 12px;">
                                    <option value="200">200 שורות</option>
                                    <option value="500" selected>500 שורות</option>
                                    <option value="1000">1000 שורות</option>
                                    <option value="2000">2000 שורות</option>
                                </select>
                                <button id="refresh-server-log" class="btn btn-small btn-primary">🔄 רענן</button>
                            </div>
                        </div>
                        <div class="console" id="server-log-console">
                            <div style="text-align: center; color: var(--gray); padding: 40px;">לחצו על "רענן" כדי לטעון
                                את לוג השרת</div>
                        </div>
                    </div>
                </section>
            </div>

        </main>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="/public/js/dashboard.js"></script>
</body>

</html>